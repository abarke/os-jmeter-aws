# Fetch logs from JMeter instances and generate a JMeter report

function usage() {
    cat <<-EOF

    Fetch logs from JMeter instances and generate a JMeter report

    Usage: $0 process-logs [options]
     -h, --help             displays this help message
     -n, --name [NAME]      optional name of the test
     -k, --test-key [KEY]   optional key that identifies a test run, defaults to last test run
     -j, --jvm-args [ARGS]  optional JVM Args to pass to JMeter ("-Xms512m -Xmx2048m" etc.)

     The name of a test will be lower cased and all whitespace replaced with underscores.

     If a script name is not provided the name of the current working directory will be used.

EOF
}

JVM_ARGS=
typeset -i COUNT=1
while (( $# > 0 )); do
    key="$1"
    case $key in
        -h|--help)
            usage
            exit 0
            ;;
        -n|--name)
            set-test-name "$2"
            shift
            ;;
        -k|--test-key)
            TEST_KEY=$2
            shift
            ;;
        -j|--jvm-args)
            JVM_ARGS=$2
            shift
            ;;
        *)
            # Ignore or exit here
        ;;
    esac
    shift
done

# Name is optional if script is being run from the test directory
if [[ -z ${TEST_NAME} ]]; then
    if [[ -r ./config ]]; then
        set-test-name-from-cwd
    else
        error "You must provide a test name"
    fi
fi

if [[ ! -d ${TEST_DIR} ]]; then
    error "Test directory '${TEST_DIR}' does not exists."
fi

TEST_RUN_LOGS=${TEST_DIR}/test-runs.log
PROCESSED_REPORT=${TEST_DIR}/processed-reports.log

if [[ -z ${TEST_KEY} ]]; then
    if [[ ! -r ${TEST_RUN_LOGS} ]]; then
        error "No test runs have been logged yet"
    fi
    TEST_KEY=$(tail -1 ${TEST_RUN_LOGS})
    check $? "Unable to read last test key from ${TEST_RUN_LOGS}"

    if [[ -z ${TEST_KEY} ]]; then
        error "There was no last test run key in ${TEST_RUN_LOGS}"
    fi
fi

if [[ -r ${PROCESSED_REPORT} ]]; then
    T=$(grep -q "^${TEST_KEY}$" ${PROCESSED_REPORT})
    if (( $? == 0 )); then
        error "Test run '${TEST_KEY}' has already been processed"
    fi
fi

source ${TEST_DIR}/config
source ${CMD_DIR}/verify
source ${TEST_DIR}/elk
source ${TEST_DIR}/jmeter
source ${CMD_DIR}/public-or-private

REPORT_SCRIPT_NAME=generate-report_${TEST_KEY}.sh
REPORT_SCRIPT=${WORK_DIR}/local/${REPORT_SCRIPT_NAME}

# Create local folder
mkdir -p ${WORK_DIR}/local

# Create a script that will run in the docker container
cp ${RES_DIR}/generate-report.sh ${REPORT_SCRIPT}
check $? "Unable to create working copy of process logs script"

# Make script executable
chmod 755 ${REPORT_SCRIPT}
check $? "Unable to make working copy of process logs script executable"

# Substitute values for place holders in process logs script
sed -i \
 -e "s|%TEST_KEY%|${TEST_KEY}|" \
 -e "s|%TEST_DIR%|${TEST_DIR}|" \
 ${REPORT_SCRIPT}
check $? "Unable to replace placeholders in working copy of process logs script"

JVMARGS=""
if [[ ${JVM_ARGS} ]]; then
    JVMARGS="-e 'JVM_ARGS=${JVM_ARGS}'"
fi

# Execute it as a background task
sudo nohup docker run --rm \
${JVMARGS} \
-v /home/ec2-user/${TEST_NAME}/logs:/logs \
-v /home/ec2-user/${TEST_NAME}/work:/work \
--entrypoint "/work/local/${REPORT_SCRIPT_NAME}" \
ordnancesurvey/jmeter:v2.0 > /home/ec2-user/${TEST_NAME}/logs/generate-report-docker_${TEST_KEY}.log 2>&1 &\

# Mark this test key as processed
echo "${TEST_KEY}" >> ${PROCESSED_REPORT}
echo ""
echo "Report generation is asynchronous and may take a few minutes."
echo ""
echo "Once finished a report will be generated."
echo ""
